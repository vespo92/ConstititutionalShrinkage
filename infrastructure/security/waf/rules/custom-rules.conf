# Custom WAF Rules for Constitutional Shrinkage Platform

# ============================================================================
# VOTING SECURITY RULES
# ============================================================================

# Prevent vote replay attacks
SecRule REQUEST_URI "@rx ^/api/v\d+/votes" \
    "id:1000001,\
    phase:2,\
    block,\
    log,\
    msg:'Potential vote replay attack',\
    tag:'voting-security',\
    severity:'CRITICAL',\
    chain"
    SecRule REQUEST_HEADERS:X-Vote-Nonce "^$" \
        "t:none"

# Detect vote manipulation attempts
SecRule REQUEST_URI "@rx ^/api/v\d+/votes" \
    "id:1000002,\
    phase:2,\
    block,\
    log,\
    msg:'Vote manipulation attempt detected',\
    tag:'voting-security',\
    severity:'CRITICAL',\
    chain"
    SecRule ARGS:vote_count "@gt 1" \
        "t:none"

# Detect bulk voting patterns
SecRule REQUEST_URI "@rx ^/api/v\d+/votes" \
    "id:1000003,\
    phase:2,\
    block,\
    log,\
    msg:'Bulk voting pattern detected',\
    tag:'voting-security',\
    severity:'HIGH',\
    chain"
    SecRule &ARGS:bill_id "@gt 5" \
        "t:none"

# ============================================================================
# AUTHENTICATION SECURITY RULES
# ============================================================================

# Detect credential enumeration
SecRule REQUEST_URI "@rx ^/api/v\d+/auth/(login|register)" \
    "id:1000010,\
    phase:2,\
    pass,\
    log,\
    msg:'Authentication attempt',\
    tag:'auth-security',\
    setvar:'ip.auth_attempts=+1',\
    expirevar:'ip.auth_attempts=300'"

SecRule IP:AUTH_ATTEMPTS "@gt 10" \
    "id:1000011,\
    phase:2,\
    block,\
    log,\
    msg:'Too many authentication attempts',\
    tag:'auth-security',\
    severity:'HIGH'"

# Detect password spraying
SecRule REQUEST_URI "@rx ^/api/v\d+/auth/login" \
    "id:1000012,\
    phase:2,\
    pass,\
    log,\
    msg:'Login attempt tracking',\
    tag:'auth-security',\
    setvar:'ip.login_users=%{ARGS:email}',\
    expirevar:'ip.login_users=600'"

# Block common weak passwords
SecRule REQUEST_URI "@rx ^/api/v\d+/auth/(register|password)" \
    "id:1000013,\
    phase:2,\
    block,\
    log,\
    msg:'Weak password detected',\
    tag:'auth-security',\
    severity:'MEDIUM',\
    chain"
    SecRule ARGS:password "@pmFromFile /etc/modsecurity/data/common-passwords.txt" \
        "t:lowercase"

# ============================================================================
# API SECURITY RULES
# ============================================================================

# Detect API abuse patterns
SecRule REQUEST_URI "@rx ^/api/" \
    "id:1000020,\
    phase:2,\
    pass,\
    log,\
    msg:'API request',\
    tag:'api-security',\
    setvar:'ip.api_requests=+1',\
    expirevar:'ip.api_requests=60'"

SecRule IP:API_REQUESTS "@gt 100" \
    "id:1000021,\
    phase:2,\
    block,\
    log,\
    msg:'API rate limit exceeded',\
    tag:'api-security',\
    severity:'MEDIUM'"

# Detect GraphQL introspection in production
SecRule REQUEST_URI "@rx ^/graphql" \
    "id:1000022,\
    phase:2,\
    block,\
    log,\
    msg:'GraphQL introspection blocked',\
    tag:'api-security',\
    severity:'LOW',\
    chain"
    SecRule REQUEST_BODY "@rx __schema|__type" \
        "t:lowercase"

# Detect JWT tampering attempts
SecRule REQUEST_HEADERS:Authorization "@rx ^Bearer\s+[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.(.{0,5}|.{1000,})$" \
    "id:1000023,\
    phase:1,\
    block,\
    log,\
    msg:'Malformed JWT detected',\
    tag:'api-security',\
    severity:'HIGH'"

# ============================================================================
# ADMIN PROTECTION RULES
# ============================================================================

# Protect admin endpoints
SecRule REQUEST_URI "@rx ^/api/v\d+/admin" \
    "id:1000030,\
    phase:1,\
    pass,\
    log,\
    msg:'Admin endpoint access',\
    tag:'admin-security',\
    setvar:'tx.admin_access=1'"

SecRule TX:ADMIN_ACCESS "@eq 1" \
    "id:1000031,\
    phase:2,\
    block,\
    log,\
    msg:'Admin access from untrusted IP',\
    tag:'admin-security',\
    severity:'CRITICAL',\
    chain"
    SecRule REMOTE_ADDR "!@ipMatchFromFile /etc/modsecurity/data/admin-whitelist.txt"

# ============================================================================
# DATA EXFILTRATION PREVENTION
# ============================================================================

# Detect large response bodies
SecRule RESPONSE_BODY "@rx .{1000000,}" \
    "id:1000040,\
    phase:4,\
    block,\
    log,\
    msg:'Large response body detected - potential data exfiltration',\
    tag:'data-security',\
    severity:'HIGH'"

# Detect bulk data export
SecRule RESPONSE_HEADERS:Content-Type "@rx application/json" \
    "id:1000041,\
    phase:4,\
    pass,\
    log,\
    msg:'Large JSON response',\
    tag:'data-security',\
    chain"
    SecRule RESPONSE_BODY "@rx \"results\":\s*\[.{100000,}" \
        "block,\
        msg:'Bulk data export detected',\
        severity:'HIGH'"

# ============================================================================
# BOT DETECTION RULES
# ============================================================================

# Detect headless browsers
SecRule REQUEST_HEADERS:User-Agent "@rx (headless|phantom|puppeteer|playwright|selenium|webdriver)" \
    "id:1000050,\
    phase:1,\
    block,\
    log,\
    msg:'Headless browser detected',\
    tag:'bot-detection',\
    severity:'MEDIUM'"

# Detect missing browser headers
SecRule REQUEST_HEADERS:Accept "^$" \
    "id:1000051,\
    phase:1,\
    block,\
    log,\
    msg:'Missing Accept header - possible bot',\
    tag:'bot-detection',\
    severity:'LOW',\
    chain"
    SecRule REQUEST_HEADERS:Accept-Language "^$" \
        "t:none"

# ============================================================================
# SCANNER DETECTION
# ============================================================================

# Detect vulnerability scanners
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile /etc/modsecurity/data/scanners.txt" \
    "id:1000060,\
    phase:1,\
    block,\
    log,\
    msg:'Security scanner detected',\
    tag:'scanner-detection',\
    severity:'MEDIUM'"

# Detect path enumeration
SecRule TX:ANOMALY_SCORE "@ge 3" \
    "id:1000061,\
    phase:2,\
    block,\
    log,\
    msg:'Possible path enumeration attack',\
    tag:'scanner-detection',\
    severity:'MEDIUM',\
    chain"
    SecRule IP:404_COUNT "@gt 10"
