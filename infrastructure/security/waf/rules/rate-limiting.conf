# Rate Limiting Rules for Constitutional Shrinkage Platform

# ============================================================================
# GLOBAL RATE LIMITS
# ============================================================================

# Track all requests per IP
SecRule REQUEST_URI "@rx .*" \
    "id:2000001,\
    phase:1,\
    pass,\
    nolog,\
    setvar:'ip.request_count=+1',\
    expirevar:'ip.request_count=60'"

# Block if too many requests globally (100/minute)
SecRule IP:REQUEST_COUNT "@gt 100" \
    "id:2000002,\
    phase:1,\
    block,\
    log,\
    msg:'Global rate limit exceeded',\
    tag:'rate-limiting',\
    severity:'MEDIUM',\
    status:429,\
    setenv:'rate_limited=1'"

# ============================================================================
# AUTHENTICATION RATE LIMITS
# ============================================================================

# Login rate limit (5/minute per IP)
SecRule REQUEST_URI "@rx ^/api/v\d+/auth/login$" \
    "id:2000010,\
    phase:2,\
    pass,\
    nolog,\
    setvar:'ip.login_count=+1',\
    expirevar:'ip.login_count=60'"

SecRule IP:LOGIN_COUNT "@gt 5" \
    "id:2000011,\
    phase:2,\
    block,\
    log,\
    msg:'Login rate limit exceeded',\
    tag:'rate-limiting',\
    tag:'auth-security',\
    severity:'HIGH',\
    status:429"

# Registration rate limit (3/hour per IP)
SecRule REQUEST_URI "@rx ^/api/v\d+/auth/register$" \
    "id:2000012,\
    phase:2,\
    pass,\
    nolog,\
    setvar:'ip.register_count=+1',\
    expirevar:'ip.register_count=3600'"

SecRule IP:REGISTER_COUNT "@gt 3" \
    "id:2000013,\
    phase:2,\
    block,\
    log,\
    msg:'Registration rate limit exceeded',\
    tag:'rate-limiting',\
    tag:'auth-security',\
    severity:'HIGH',\
    status:429"

# Password reset rate limit (5/hour per IP)
SecRule REQUEST_URI "@rx ^/api/v\d+/auth/password/reset$" \
    "id:2000014,\
    phase:2,\
    pass,\
    nolog,\
    setvar:'ip.password_reset_count=+1',\
    expirevar:'ip.password_reset_count=3600'"

SecRule IP:PASSWORD_RESET_COUNT "@gt 5" \
    "id:2000015,\
    phase:2,\
    block,\
    log,\
    msg:'Password reset rate limit exceeded',\
    tag:'rate-limiting',\
    tag:'auth-security',\
    severity:'MEDIUM',\
    status:429"

# ============================================================================
# VOTING RATE LIMITS
# ============================================================================

# Vote submission rate limit (20/minute per user)
SecRule REQUEST_URI "@rx ^/api/v\d+/votes$" \
    "id:2000020,\
    phase:2,\
    pass,\
    nolog,\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "setvar:'user.vote_count=+1',\
        expirevar:'user.vote_count=60'"

SecRule USER:VOTE_COUNT "@gt 20" \
    "id:2000021,\
    phase:2,\
    block,\
    log,\
    msg:'Vote rate limit exceeded',\
    tag:'rate-limiting',\
    tag:'voting-security',\
    severity:'HIGH',\
    status:429"

# Delegation rate limit (10/minute per user)
SecRule REQUEST_URI "@rx ^/api/v\d+/delegations$" \
    "id:2000022,\
    phase:2,\
    pass,\
    nolog,\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "setvar:'user.delegation_count=+1',\
        expirevar:'user.delegation_count=60'"

SecRule USER:DELEGATION_COUNT "@gt 10" \
    "id:2000023,\
    phase:2,\
    block,\
    log,\
    msg:'Delegation rate limit exceeded',\
    tag:'rate-limiting',\
    tag:'voting-security',\
    severity:'MEDIUM',\
    status:429"

# ============================================================================
# SEARCH RATE LIMITS
# ============================================================================

# Search rate limit (30/minute per IP)
SecRule REQUEST_URI "@rx ^/api/v\d+/search" \
    "id:2000030,\
    phase:1,\
    pass,\
    nolog,\
    setvar:'ip.search_count=+1',\
    expirevar:'ip.search_count=60'"

SecRule IP:SEARCH_COUNT "@gt 30" \
    "id:2000031,\
    phase:1,\
    block,\
    log,\
    msg:'Search rate limit exceeded',\
    tag:'rate-limiting',\
    severity:'LOW',\
    status:429"

# ============================================================================
# API ENDPOINT SPECIFIC LIMITS
# ============================================================================

# User profile updates (10/minute)
SecRule REQUEST_URI "@rx ^/api/v\d+/users/[^/]+/profile$" \
    "id:2000040,\
    phase:2,\
    pass,\
    nolog,\
    chain"
    SecRule REQUEST_METHOD "@rx PUT|PATCH" \
        "setvar:'user.profile_update=+1',\
        expirevar:'user.profile_update=60'"

SecRule USER:PROFILE_UPDATE "@gt 10" \
    "id:2000041,\
    phase:2,\
    block,\
    log,\
    msg:'Profile update rate limit exceeded',\
    tag:'rate-limiting',\
    severity:'LOW',\
    status:429"

# Notification read (50/minute)
SecRule REQUEST_URI "@rx ^/api/v\d+/notifications" \
    "id:2000050,\
    phase:1,\
    pass,\
    nolog,\
    setvar:'user.notification_read=+1',\
    expirevar:'user.notification_read=60'"

SecRule USER:NOTIFICATION_READ "@gt 50" \
    "id:2000051,\
    phase:1,\
    block,\
    log,\
    msg:'Notification read rate limit exceeded',\
    tag:'rate-limiting',\
    severity:'LOW',\
    status:429"

# ============================================================================
# ADMIN RATE LIMITS
# ============================================================================

# Admin actions (60/minute)
SecRule REQUEST_URI "@rx ^/api/v\d+/admin" \
    "id:2000060,\
    phase:2,\
    pass,\
    nolog,\
    setvar:'user.admin_action=+1',\
    expirevar:'user.admin_action=60'"

SecRule USER:ADMIN_ACTION "@gt 60" \
    "id:2000061,\
    phase:2,\
    block,\
    log,\
    msg:'Admin action rate limit exceeded',\
    tag:'rate-limiting',\
    tag:'admin-security',\
    severity:'MEDIUM',\
    status:429"

# ============================================================================
# BURST PROTECTION
# ============================================================================

# Detect request bursts (10 requests in 1 second)
SecRule REQUEST_URI "@rx .*" \
    "id:2000070,\
    phase:1,\
    pass,\
    nolog,\
    setvar:'ip.burst_count=+1',\
    expirevar:'ip.burst_count=1'"

SecRule IP:BURST_COUNT "@gt 10" \
    "id:2000071,\
    phase:1,\
    block,\
    log,\
    msg:'Request burst detected',\
    tag:'rate-limiting',\
    tag:'dos-protection',\
    severity:'HIGH',\
    status:429"
