# ModSecurity Configuration
# Constitutional Shrinkage Platform

# Enable ModSecurity
SecRuleEngine On

# Request body handling
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Response body handling
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# Temporary file settings
SecTmpDir /var/cache/modsecurity/tmp/
SecDataDir /var/cache/modsecurity/data/

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsecurity/modsec_audit.log

# Debug logging (disable in production)
SecDebugLog /var/log/modsecurity/debug.log
SecDebugLogLevel 0

# Rule engine settings
SecArgumentSeparator &
SecCookieFormat 0
SecUnicodeMapFile unicode.mapping 20127

# Default action
SecDefaultAction "phase:1,log,auditlog,pass"
SecDefaultAction "phase:2,log,auditlog,pass"

# Include OWASP CRS
Include /etc/modsecurity/crs/crs-setup.conf
Include /etc/modsecurity/crs/rules/*.conf

# Include custom rules
Include /etc/modsecurity/custom-rules.conf
Include /etc/modsecurity/rate-limiting.conf

# Server identification
SecServerSignature "Constitutional Shrinkage"

# Paranoia level (1-4, higher = more strict)
SecAction \
  "id:900000,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.paranoia_level=2"

# Anomaly scoring thresholds
SecAction \
  "id:900110,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.inbound_anomaly_score_threshold=5,\
   setvar:tx.outbound_anomaly_score_threshold=4"

# Enable blocking mode
SecAction \
  "id:900120,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.blocking_paranoia_level=2"

# Allowed HTTP methods
SecAction \
  "id:900200,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.allowed_methods=GET HEAD POST PUT DELETE OPTIONS PATCH'"

# Allowed request content types
SecAction \
  "id:900220,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.allowed_request_content_type=|application/json|application/x-www-form-urlencoded|multipart/form-data|text/plain|'"

# Static file extensions (skip scanning)
SecAction \
  "id:900240,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.static_extensions=/.css/.js/.png/.jpg/.jpeg/.gif/.ico/.svg/.woff/.woff2/'"
